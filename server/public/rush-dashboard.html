<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rush Period Analyzer - Aadhaar Enrollment</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa;
            --white: #ffffff;
            --border: #e0e0e0;
            --accent: #1a73e8;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --text: #202124;
            --muted: #5f6368;
            --shadow: 0 1px 3px rgba(60, 64, 67, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .header {
            background: var(--white);
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1::before {
            content: 'üìÖ';
            font-size: 24px;
        }

        .controls {
            background: var(--white);
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls select {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            min-width: 180px;
        }

        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary {
            background: var(--warning);
            color: #1f1f1f;
        }

        .btn-primary:hover {
            background: #1557b0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
            padding: 20px 32px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
            color: var(--text);
        }

        .summary {
            grid-column: span 4;
        }

        .dow-chart {
            grid-column: span 4;
        }

        .month-chart {
            grid-column: span 4;
        }

        .predictions {
            grid-column: span 8;
        }

        .recommendations {
            grid-column: span 4;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            background: var(--bg);
            padding: 16px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid var(--accent);
        }

        .recommendation-list li.best {
            border-left-color: var(--success);
        }

        .recommendation-list li.avoid {
            border-left-color: var(--danger);
        }

        .prediction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .prediction-table th,
        .prediction-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .prediction-table th {
            background: var(--bg);
            font-weight: 600;
        }

        .peak-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .peak-badge.high {
            background: #fce8e6;
            color: var(--danger);
        }

        .peak-badge.medium {
            background: #fef7e0;
            color: #e37400;
        }

        .peak-badge.low {
            background: #e6f4ea;
            color: var(--success);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--muted);
        }

        @media (max-width: 1200px) {

            .summary,
            .dow-chart,
            .month-chart,
            .predictions,
            .recommendations {
                grid-column: span 12;
            }

            .dashboard {
                padding: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Rush Period Analyzer</h1>
        <span id="model-info" style="font-size: 12px; color: var(--muted);">Select a district to analyze</span>
    </div>

    <div class="controls">
        <select id="state-select" onchange="loadDistricts()">
            <option value="">Select State</option>
        </select>
        <select id="district-select">
            <option value="">Select District</option>
        </select>
        <button class="btn-primary" onclick="analyzeRush()">üìä Analyze Rush Patterns</button>
        <button class="btn-secondary" onclick="predictPeaks()">üîÆ Predict Peak Days</button>
    </div>

    <div class="dashboard">
        <div class="card summary">
            <div class="card-title">üìà Rush Summary</div>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-value" id="busiest-dow">-</div>
                    <div class="stat-label">Busiest Day</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="busiest-month">-</div>
                    <div class="stat-label">Busiest Month</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="data-points">-</div>
                    <div class="stat-label">Data Points</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-enrollment">-</div>
                    <div class="stat-label">Avg Daily Load</div>
                </div>
            </div>
        </div>

        <div class="card dow-chart">
            <div class="card-title">üìÖ Day of Week Distribution</div>
            <div id="dow-chart" style="height: 250px;"></div>
        </div>

        <div class="card month-chart">
            <div class="card-title">üóìÔ∏è Monthly Distribution</div>
            <div id="month-chart" style="height: 250px;"></div>
        </div>

        <div class="card predictions">
            <div class="card-title">üîÆ Predicted Peak Days (Next 30 Days)</div>
            <div id="predictions-table">
                <p class="loading">Click "Predict Peak Days" to see predictions</p>
            </div>
        </div>

        <div class="card recommendations">
            <div class="card-title">üí° Recommendations</div>
            <ul class="recommendation-list" id="recommendations">
                <li>Select a state and district to get recommendations</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/rush';

        const STATES = [
            'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
            'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
            'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
            'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
            'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
            'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
        ];

        // Hardcoded districts for each state (10 major districts each)
        const STATE_DISTRICTS = {
            'Andhra Pradesh': ['Anantapur', 'Chittoor', 'East Godavari', 'Guntur', 'Krishna', 'Kurnool', 'Nellore', 'Prakasam', 'Visakhapatnam', 'West Godavari'],
            'Arunachal Pradesh': ['Anjaw', 'Changlang', 'East Kameng', 'East Siang', 'Lohit', 'Lower Subansiri', 'Papum Pare', 'Tawang', 'Upper Siang', 'West Kameng'],
            'Assam': ['Barpeta', 'Cachar', 'Darrang', 'Dibrugarh', 'Goalpara', 'Jorhat', 'Kamrup', 'Nagaon', 'Sivasagar', 'Sonitpur'],
            'Bihar': ['Begusarai', 'Bhagalpur', 'Gaya', 'Muzaffarpur', 'Nalanda', 'Patna', 'Purnia', 'Samastipur', 'Saran', 'Vaishali'],
            'Chhattisgarh': ['Bastar', 'Bilaspur', 'Durg', 'Janjgir-Champa', 'Korba', 'Raigarh', 'Raipur', 'Rajnandgaon', 'Surguja', 'Dhamtari'],
            'Goa': ['North Goa', 'South Goa', 'Panaji', 'Margao', 'Vasco da Gama', 'Mapusa', 'Ponda', 'Bicholim', 'Curchorem', 'Sanquelim'],
            'Gujarat': ['Ahmedabad', 'Amreli', 'Anand', 'Bharuch', 'Bhavnagar', 'Jamnagar', 'Kutch', 'Mehsana', 'Rajkot', 'Surat'],
            'Haryana': ['Ambala', 'Bhiwani', 'Faridabad', 'Gurgaon', 'Hisar', 'Jhajjar', 'Karnal', 'Panipat', 'Rohtak', 'Sonipat'],
            'Himachal Pradesh': ['Bilaspur', 'Chamba', 'Hamirpur', 'Kangra', 'Kullu', 'Mandi', 'Shimla', 'Sirmaur', 'Solan', 'Una'],
            'Jharkhand': ['Bokaro', 'Dhanbad', 'Dumka', 'East Singhbhum', 'Giridih', 'Hazaribagh', 'Palamu', 'Ranchi', 'Sahebganj', 'West Singhbhum'],
            'Karnataka': ['Bagalkot', 'Bangalore Rural', 'Bangalore Urban', 'Belgaum', 'Bellary', 'Dharwad', 'Gulbarga', 'Mysore', 'Shimoga', 'Tumkur'],
            'Kerala': ['Alappuzha', 'Ernakulam', 'Idukki', 'Kannur', 'Kollam', 'Kottayam', 'Kozhikode', 'Malappuram', 'Palakkad', 'Thiruvananthapuram'],
            'Madhya Pradesh': ['Bhopal', 'Gwalior', 'Indore', 'Jabalpur', 'Rewa', 'Sagar', 'Satna', 'Ujjain', 'Dewas', 'Chhindwara'],
            'Maharashtra': ['Ahmednagar', 'Aurangabad', 'Mumbai', 'Mumbai Suburban', 'Nagpur', 'Nashik', 'Pune', 'Solapur', 'Thane', 'Kolhapur'],
            'Manipur': ['Bishnupur', 'Chandel', 'Churachandpur', 'Imphal East', 'Imphal West', 'Senapati', 'Tamenglong', 'Thoubal', 'Ukhrul', 'Kakching'],
            'Meghalaya': ['East Garo Hills', 'East Khasi Hills', 'Jaintia Hills', 'Ri Bhoi', 'South Garo Hills', 'West Garo Hills', 'West Khasi Hills', 'South West Khasi Hills', 'North Garo Hills', 'South West Garo Hills'],
            'Mizoram': ['Aizawl', 'Champhai', 'Kolasib', 'Lawngtlai', 'Lunglei', 'Mamit', 'Saiha', 'Serchhip', 'Khawzawl', 'Hnahthial'],
            'Nagaland': ['Dimapur', 'Kohima', 'Mokokchung', 'Mon', 'Peren', 'Phek', 'Tuensang', 'Wokha', 'Zunheboto', 'Longleng'],
            'Odisha': ['Angul', 'Balasore', 'Cuttack', 'Ganjam', 'Jajapur', 'Khordha', 'Mayurbhanj', 'Puri', 'Sambalpur', 'Sundargarh'],
            'Punjab': ['Amritsar', 'Bathinda', 'Faridkot', 'Ferozepur', 'Gurdaspur', 'Jalandhar', 'Ludhiana', 'Patiala', 'Sangrur', 'Mohali'],
            'Rajasthan': ['Ajmer', 'Alwar', 'Bikaner', 'Jaipur', 'Jodhpur', 'Kota', 'Sikar', 'Udaipur', 'Bharatpur', 'Chittorgarh'],
            'Sikkim': ['East Sikkim', 'North Sikkim', 'South Sikkim', 'West Sikkim', 'Gangtok', 'Namchi', 'Mangan', 'Gyalshing', 'Pakyong', 'Soreng'],
            'Tamil Nadu': ['Chennai', 'Coimbatore', 'Cuddalore', 'Erode', 'Kanchipuram', 'Madurai', 'Salem', 'Thanjavur', 'Tiruchirappalli', 'Tirunelveli'],
            'Telangana': ['Adilabad', 'Hyderabad', 'Karimnagar', 'Khammam', 'Mahabubnagar', 'Medak', 'Nalgonda', 'Nizamabad', 'Rangareddy', 'Warangal'],
            'Tripura': ['Dhalai', 'North Tripura', 'South Tripura', 'West Tripura', 'Gomati', 'Khowai', 'Sepahijala', 'Unakoti', 'Agartala', 'Dharmanagar'],
            'Uttar Pradesh': ['Agra', 'Allahabad', 'Bareilly', 'Ghaziabad', 'Kanpur Nagar', 'Lucknow', 'Meerut', 'Moradabad', 'Varanasi', 'Gorakhpur'],
            'Uttarakhand': ['Almora', 'Chamoli', 'Dehradun', 'Haridwar', 'Nainital', 'Pauri Garhwal', 'Pithoragarh', 'Tehri Garhwal', 'Udham Singh Nagar', 'Uttarkashi'],
            'West Bengal': ['Bankura', 'Bardhaman', 'Birbhum', 'Darjeeling', 'Hooghly', 'Howrah', 'Kolkata', 'Murshidabad', 'Nadia', 'North 24 Parganas']
        };

        document.addEventListener('DOMContentLoaded', () => {
            const stateSelect = document.getElementById('state-select');
            stateSelect.innerHTML = '<option value="">Select State</option>' +
                STATES.map(s => `<option value="${s}">${s}</option>`).join('');
        });

        function loadDistricts() {
            const state = document.getElementById('state-select').value;
            const districtSelect = document.getElementById('district-select');

            if (!state) {
                districtSelect.innerHTML = '<option value="">Select District</option>';
                return;
            }

            // Use hardcoded districts
            const districts = STATE_DISTRICTS[state] || [];

            if (districts.length > 0) {
                districtSelect.innerHTML = '<option value="">Select District</option>' +
                    districts.map(d => `<option value="${d}">${d}</option>`).join('');
            } else {
                districtSelect.innerHTML = '<option value="">No districts available</option>';
            }
        }

        async function analyzeRush() {
            const state = document.getElementById('state-select').value;
            const district = document.getElementById('district-select').value;

            if (!state || !district) {
                alert('Please select state and district');
                return;
            }

            document.getElementById('model-info').textContent = 'Analyzing...';

            try {
                const res = await fetch(`${API_BASE}/analyze/${encodeURIComponent(state)}/${encodeURIComponent(district)}`);
                const data = await res.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                // Update summary
                document.getElementById('busiest-dow').textContent = data.busiest_day_of_week?.day || '-';
                document.getElementById('busiest-month').textContent = data.busiest_month?.month?.slice(0, 3) || '-';
                document.getElementById('data-points').textContent = data.data_points || '-';
                document.getElementById('avg-enrollment').textContent = Math.round(data.busiest_day_of_week?.avg_enrollment || 0);

                document.getElementById('model-info').textContent =
                    `${district}, ${state} | ${data.date_range?.start} to ${data.date_range?.end}`;

                // Day of week chart
                if (data.day_of_week_distribution) {
                    const dowData = data.day_of_week_distribution;
                    Plotly.newPlot('dow-chart', [{
                        x: dowData.map(d => d.day_name?.slice(0, 3)),
                        y: dowData.map(d => d.mean),
                        type: 'bar',
                        marker: { color: dowData.map(d => d.mean === Math.max(...dowData.map(x => x.mean)) ? '#ea4335' : '#1a73e8') }
                    }], {
                        margin: { l: 40, r: 20, t: 10, b: 30 },
                        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                        font: { size: 11 },
                        yaxis: { gridcolor: '#eee' }
                    }, { responsive: true, displayModeBar: false });
                }

                // Monthly chart
                if (data.monthly_distribution && data.monthly_distribution.length > 0) {
                    const monthData = data.monthly_distribution;
                    Plotly.newPlot('month-chart', [{
                        x: monthData.map(d => d.month_name?.slice(0, 3)),
                        y: monthData.map(d => d.mean),
                        type: 'bar',
                        marker: { color: monthData.map(d => d.mean === Math.max(...monthData.map(x => x.mean)) ? '#ea4335' : '#34a853') }
                    }], {
                        margin: { l: 40, r: 20, t: 10, b: 30 },
                        paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                        font: { size: 11 },
                        yaxis: { gridcolor: '#eee' }
                    }, { responsive: true, displayModeBar: false });
                }

                // Recommendations
                if (data.recommendations) {
                    const recList = document.getElementById('recommendations');
                    recList.innerHTML = data.recommendations.map(r => {
                        const cls = r.includes('‚úÖ') ? 'best' : r.includes('‚ùå') ? 'avoid' : '';
                        return `<li class="${cls}">${r}</li>`;
                    }).join('');
                }

            } catch (e) {
                console.error('Analysis error:', e);
                alert('Error analyzing data: ' + e.message);
            }
        }

        async function predictPeaks() {
            const state = document.getElementById('state-select').value;
            const district = document.getElementById('district-select').value;

            if (!state || !district) {
                alert('Please select state and district first');
                return;
            }

            // Show loading state with training message
            document.getElementById('predictions-table').innerHTML = `
                <div class="loading" style="text-align: center; padding: 30px;">
                    <div style="font-size: 24px; margin-bottom: 15px;">‚è≥</div>
                    <p style="font-weight: 600; color: var(--accent);">Calibrating ML Model...</p>
                    <p style="font-size: 12px; color: var(--muted);">Training using all available historical data.</p>
                    <p style="font-size: 12px; color: var(--muted);">Predictions will be shown once training completes.</p>
                </div>
            `;

            try {
                // Step 1: Train the model first (on-demand training)
                const trainRes = await fetch(`${API_BASE}/train/${encodeURIComponent(state)}/${encodeURIComponent(district)}`, {
                    method: 'POST'
                });
                const trainData = await trainRes.json();

                // Update loading state
                document.getElementById('predictions-table').innerHTML = `
                    <div class="loading" style="text-align: center; padding: 30px;">
                        <div style="font-size: 24px; margin-bottom: 15px;">üîÆ</div>
                        <p style="font-weight: 600; color: var(--success);">Model Calibrated!</p>
                        <p style="font-size: 12px; color: var(--muted);">Generating predictions...</p>
                    </div>
                `;

                // Step 2: Get fresh predictions (disable cached)
                const res = await fetch(`${API_BASE}/predict/${encodeURIComponent(state)}/${encodeURIComponent(district)}?days=30&nocache=${Date.now()}`);
                const data = await res.json();

                if (data.error) {
                    document.getElementById('predictions-table').innerHTML = `<p class="loading">${data.error}</p>`;
                    return;
                }

                const peaks = data.peak_days || data.all_predictions?.filter(p => p.is_peak) || data.all_predictions?.slice(0, 10);

                if (!peaks || peaks.length === 0) {
                    document.getElementById('predictions-table').innerHTML = '<p class="loading">No peak days predicted</p>';
                    return;
                }

                // Show model info banner
                const modelInfo = trainData.success ?
                    `<div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px;">
                        <strong>‚úÖ Model Trained</strong> | 
                        MAPE: ${trainData.metrics?.mape || 'N/A'}% | 
                        Data Points: ${trainData.data_points || 'N/A'}
                    </div>` :
                    (data.is_synthetic ?
                        `<div style="background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px;">
                            <strong>‚ö†Ô∏è Using Estimated Patterns</strong> | 
                            Insufficient historical data for ML training
                        </div>` : '');

                const tableHtml = `
                    ${modelInfo}
                    <table class="prediction-table">
                        <thead>
                            <tr><th>Date</th><th>Day</th><th>Predicted Load</th><th>Confidence</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            ${peaks.slice(0, 10).map(p => `
                                <tr>
                                    <td>${p.date}</td>
                                    <td>${p.day_name}</td>
                                    <td>${p.predicted_enrollment?.toLocaleString() || '-'}</td>
                                    <td>${Math.round((p.confidence || 0) * 100)}%</td>
                                    <td><span class="peak-badge ${p.is_peak ? 'high' : 'low'}">${p.is_peak ? 'Peak' : 'Normal'}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('predictions-table').innerHTML = tableHtml;

            } catch (e) {
                console.error('Prediction error:', e);
                document.getElementById('predictions-table').innerHTML = `<p class="loading">Error: ${e.message}</p>`;
            }
        }
    </script>
</body>

</html>